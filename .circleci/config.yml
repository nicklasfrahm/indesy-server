defaults: &defaults
  working_directory: ~/indesy-server
  docker:
    - image: circleci/node:7.10
version: 2
jobs:
  purge:
    <<: *defaults
    steps:
      - run:
          name: "Stop Deployment"
          command: ssh -p 61000 -o StrictHostKeyChecking=no root@$SERVER_IP 'cd /opt/indesy && npm run prod:stop || true'
      - run:
          name: "Purge Deployment"
          command: ssh -p 61000 -o StrictHostKeyChecking=no root@$SERVER_IP 'rm -r /opt/indesy || true'
      - run:
          name: "Clone Repository"
          command: ssh -p 61000 -o StrictHostKeyChecking=no root@$SERVER_IP 'git clone https://github.com/nicklasfrahm/indesy-server /opt/indesy'
  dependencies:
    <<: *defaults
    steps:
      - run:
          name: "Install Dependencies"
          command: ssh -p 61000 -o StrictHostKeyChecking=no root@$SERVER_IP 'cd /opt/indesy && npm install'
  artifacts:
    <<: *defaults
    steps:
      - run:
          name: "Install Artifacts"
          command: ssh -p 61000 -o StrictHostKeyChecking=no root@$SERVER_IP 'echo "<html><body><h1>Test</h1></body></html>" > /opt/indesy/public/index.html'
  deploy:
    <<: *defaults
    steps:
      - run:
          name: "Start Deployment"
          command: ssh -p 61000 -o StrictHostKeyChecking=no root@$SERVER_IP 'cd /opt/indesy && npm run prod:start'
workflows:
  version: 2
  deploy-application-stack:
    jobs:
      - purge:
          filters:
            branches:
              only: master
      - dependencies:
          requires:
            - purge
      - artifacts:
          requires:
            - purge
      - deploy:
          requires:
            - dependencies
            - artifacts